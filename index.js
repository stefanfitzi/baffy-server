/*
 * REST service providing all functionality needed for CRUD operations on member entity
 */
var express = require('express')
var bodyParser = require('body-parser');
var mysql = require('mysql')
var propertiesReader = require('properties-reader');

var app = express()

// CORS implementation
var allowCrossDomain = function(req, res, next) {
    res.header('Access-Control-Allow-Origin', "*");
    res.header('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE');
    res.header('Access-Control-Allow-Headers', 'Content-Type');
    next();
}
app.use(allowCrossDomain);

// parse incoming request bodies in a middleware before your handlers and makes them available under req.body
app.use(bodyParser.json());

var properties = propertiesReader('application.properties');

// database connection pool (configured with values from file application.properties)
var pool = mysql.createPool({
    connectionLimit: properties.get('db.pool.connectionLimit'),
    host: properties.get('db.pool.host'),
    user: properties.get('db.pool.user'),
    password: properties.get('db.pool.password'),
    database: properties.get('db.pool.database'),
    debug: properties.get('db.pool.debug'),
});

function printOutProperties() {
    return '\ndb-host: ' + properties.get('db.pool.host') + '\ndatabase: ' + properties.get('db.pool.database') + '\ndb-user: ' + properties.get('db.pool.user');
}

// show configuration on startup
console.log('start application with the following properties: ' + printOutProperties());

// base function for all database requests (parameters: res=http response, query=SQL query with '?' placeholders, data=object with a value for every query placeholder)
function handle_database(res, query, data) {

    pool.getConnection(function (err, connection) {
        if (err) {
            res.json({ "code": 100, "status": "Error in connection database" });
            return;
        }

        connection.query(query, data, function (err, rows) {
            connection.release();
            if (!err) {
                res.json(rows);
            }
        });

        connection.on('error', function (err) {
            res.json({ "code": 100, "status": "Error executing the query: " + query + "with data: " + data });
            return;
        });
    });
}

/**** member functions ****/
// get all members
app.get('/member', function (req, res) {
    console.log('request: ' + req.method + ' all members');
    handle_database(res, 'select * from member');
})

// get one member by id
app.get('/member/:id', function (req, res) {
    console.log('request: ' + req.method + ' member with id ' + req.params.id);
    handle_database(res, 'select * from member where id=?', req.params.id);
})

// store a new member (id is generated by database)
app.post('/member', function (req, res) {
    console.log('request: ' + req.method + ' member with data: ' + JSON.stringify(req.body));
    var data = req.body;
    handle_database(res, 'insert into member set ?', data);
})

// update an existing member
app.put('/member', function (req, res) {
    console.log('request: ' + req.method + ' member with data: ' + JSON.stringify(req.body));
    var data = req.body;
    handle_database(res, 'update member set ? where id=?', [data, data.id]);
})

// delete one member by id
app.delete('/member/:id', function (req, res) {
    console.log('request: ' + req.method + ' member with id ' + req.params.id);
    handle_database(res, 'delete from member where id=?', req.params.id);
})

/**** event functions ****/
// get all events
app.get('/event', function (req, res) {
    console.log('request: ' + req.method + ' all events');
    handle_database(res, 'select * from event');
})

// get one event by id
app.get('/event/:id', function (req, res) {
    console.log('request: ' + req.method + ' event with id ' + req.params.id);
    handle_database(res, 'select * from event where id=?', req.params.id);
})

// store a new event (id is generated by database)
app.post('/event', function (req, res) {
    console.log('request: ' + req.method + ' event with data: ' + JSON.stringify(req.body));
    var data = req.body;
    handle_database(res, 'insert into event set ?', data);
})

// update an existing event
app.put('/event', function (req, res) {
    console.log('request: ' + req.method + ' event with data: ' + JSON.stringify(req.body));
    var data = req.body;
    handle_database(res, 'update event set ? where id=?', [data, data.id]);
})

// delete one event by id
app.delete('/event/:id', function (req, res) {
    console.log('request: ' + req.method + ' event with id ' + req.params.id);
    handle_database(res, 'delete from event where id=?', req.params.id);
})

/**** registrations functions ****/
// get all members registered for the event with id
app.get('/registration/:id', function (req, res) {
    console.log('request: ' + req.method + ' all members');
    handle_database(res, 'select m.* from member m, registration r where m.id=r.fk_member and r.fk_event=?', req.params.id);
})

// store a new registration (id is generated by database)
app.post('/registration', function (req, res) {
    console.log('request: ' + req.method + ' registration with data: ' + JSON.stringify(req.body));
    var data = req.body;
    handle_database(res, 'insert into registration set ?', data);
})

/**** evemt types functions ****/
// get all evemt types
app.get('/eventtype', function (req, res) {
    console.log('request: ' + req.method + ' all event types');
    handle_database(res, 'select * from event_type');
})

// store a new event type (id is generated by database)
app.post('/eventtype', function (req, res) {
    console.log('request: ' + req.method + ' event type with data: ' + JSON.stringify(req.body));
    var data = req.body;
    handle_database(res, 'insert into event_type set ?', data);
})

// update an existing event type
app.put('/eventtype', function (req, res) {
    console.log('request: ' + req.method + ' even type with data: ' + JSON.stringify(req.body));
    var data = req.body;
    handle_database(res, 'update event_type set ? where id=?', [data, data.id]);
})

// delete one event type by id
app.delete('/eventtype/:id', function (req, res) {
    console.log('request: ' + req.method + ' event type with id ' + req.params.id);
    handle_database(res, 'delete from event_type where id=?', req.params.id);
})

// start REST service on port 3000
app.listen(3000)